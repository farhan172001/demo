Write unit test cases for this service: code : Service: 2 usages

@RequiredArgsConstructor

public class FileTransferEventService {

private final S3Properties s3Properties;

private final ExtreamContentFileTransferProducer fileTransferProducer;

public void publishFileTransferEvent(String key, RetadataModel metadata) throws ApplicationException {

try {

String sourceuri buildSourceUri(key);

String destinationuri buildDestinationUri(key, metadata);

FileTransferRequest updatedFileTransferRequest FileTransferRequest.builder()

sourceURI(sourceuri)

destinationURIs(List.of(destinationuri))

isresponseRequired (Boolean. TRUE)

.build();

FileTransferEvent event FileTransferEvent.builder()

fileTransferRequest(updated FileTransferRequest)

.build();

fileTransferProducer.send(event);

AppLogger.info(this.getClass(), msg: "File transfer event published. Source: 1, Destination: ()"

sourceüri, destinationUri);

} catch (Exception e)(AppLogger.error(this.getClass(), msg "Failed to publish file transfer event. Reason: ()", e.getMessage

throw new ApplicationException("Failed to publish file transfer event", e, ExceptionType.TECHNICAL);

private String buildSourceUri(string filename) throws ApplicationException { Tusage

String bucketllame $3Properties.getBucketName();

if (bucketName= null || filename == null) {

AppLogger.error(this.getClass(), msg "Missing required S3 properties");

throw new DataFormatException("Missing required 53 properties, null, ExceptionType.TECHNICAL);

return String.format("s://%s/%s", bucketName, filename);


}

private String buildDestinationUri(String fileName, Metadatañadel netadata)

if (metadata.getGroupNumber() == πυλί 11

throws ApplicationException { usage

metadata.getCorrTransactionId() NULL)

AppLogger.error(this.getClass(), msg: "Missing required field");

I

throw new DateFormatException("Missing required field", null, ExceptionType. TECHNICAL);}return String.format(

"filenet://%s?"

"claimNumber=%s&"

"certificateNumber=%s&"


"group Number=%s&"

"corrTransactionId=%s&"

"corrSubTransactionId=%s&"

"eventName=%s&"

"disbursementId=%s&"

"documentClass=%s&"

"objectStore=%s&"

"acc=%s&"

"title=%s",


fileName,

safe(metadata.getClaimNumber()),

safe(metadata.getCertificateNumber()),

safe(metadata.getGroupNumber()),

safe(metadata.getCorrTransactionId()),

safe(metadata.getCorrSubTransactionId(),

safe(metadata.getEventName()),

safe(metadata.getDisbursementId()),

safe(metadata.getDocumentClass()),

safe(metadata.getObjectStore()),

safe(metadata.getAcc()),safe(metadata.getTitle())

private String safe (String value) { return value == null ? "": value; }


import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class FileTransferEventServiceTest {

    private S3Properties s3Properties;
    private ExtreamContentFileTransferProducer producer;
    private FileTransferEventService service;

    @BeforeEach
    void setUp() {
        s3Properties = mock(S3Properties.class);
        producer = mock(ExtreamContentFileTransferProducer.class);
        service = new FileTransferEventService(s3Properties, producer);

        when(s3Properties.getBucketName()).thenReturn("test-bucket");
    }

    // ---------------------------------------------------------------------
    // TEST 1: publishFileTransferEvent SUCCESS
    // ---------------------------------------------------------------------
    @Test
    void testPublishFileTransferEvent_Success() throws Exception {
        // Arrange metadata
        MetadataModel metadata = MetadataModel.builder()
                .claimNumber("C1")
                .certificateNumber("CERT1")
                .groupNumber("G1")
                .corrTransactionId("T1")
                .corrSubTransactionId("ST1")
                .eventName("EVT")
                .disbursementId("D1")
                .documentClass("DOC")
                .objectStore("OS")
                .acc("ACC")
                .title("Title")
                .build();

        // Act
        service.publishFileTransferEvent("file.txt", metadata);

        // Assert event sent to producer
        ArgumentCaptor<FileTransferEvent> captor = ArgumentCaptor.forClass(FileTransferEvent.class);
        verify(producer, times(1)).send(captor.capture());

        FileTransferEvent event = captor.getValue();
        assertNotNull(event);
        assertNotNull(event.getFileTransferRequest());
        assertEquals(1, event.getFileTransferRequest().getDestinationURIs().size());
        assertTrue(event.getFileTransferRequest().isResponseRequired());
    }

    // ---------------------------------------------------------------------
    // TEST 2: publishFileTransferEvent FAILURE WHEN PRODUCER THROWS
    // ---------------------------------------------------------------------
    @Test
    void testPublishFileTransferEvent_ProducerThrowsException() throws Exception {
        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        doThrow(new RuntimeException("Kafka Down"))
                .when(producer).send(any());

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.publishFileTransferEvent("file.txt", metadata)
        );

        assertTrue(ex.getMessage().contains("Failed to publish file transfer event"));
    }

    // ---------------------------------------------------------------------
    // TEST 3: buildSourceUri SUCCESS
    // ---------------------------------------------------------------------
    @Test
    void testBuildSourceUri_Success() throws Exception {
        String result = invokeBuildSourceUri("abc.txt");
        assertEquals("s://test-bucket/abc.txt", result);
    }

    // ---------------------------------------------------------------------
    // TEST 4: buildSourceUri FAILS WHEN BUCKET NULL
    // ---------------------------------------------------------------------
    @Test
    void testBuildSourceUri_MissingBucket_ThrowsException() {
        when(s3Properties.getBucketName()).thenReturn(null);

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> invokeBuildSourceUri("file.txt")
        );

        assertTrue(ex.getMessage().contains("Missing required S3 properties"));
    }

    // ---------------------------------------------------------------------
    // TEST 5: buildDestinationUri SUCCESS
    // ---------------------------------------------------------------------
    @Test
    void testBuildDestinationUri_Success() throws Exception {
        MetadataModel metadata = MetadataModel.builder()
                .claimNumber("C1")
                .certificateNumber("CERT1")
                .groupNumber("G1")
                .corrTransactionId("T1")
                .corrSubTransactionId("ST1")
                .eventName("EVT")
                .disbursementId("D1")
                .documentClass("DOC")
                .objectStore("OS")
                .acc("ACC")
                .title("Title")
                .build();

        String result = invokeBuildDestinationUri("file.txt", metadata);

        assertTrue(result.startsWith("filenet://file.txt?"));
        assertTrue(result.contains("claimNumber=C1"));
        assertTrue(result.contains("groupNumber=G1"));
    }

    // ---------------------------------------------------------------------
    // TEST 6: buildDestinationUri FAILS WHEN REQUIRED FIELDS MISSING
    // ---------------------------------------------------------------------
    @Test
    void testBuildDestinationUri_MissingRequiredFields_ThrowsException() {
        MetadataModel metadata = MetadataModel.builder()
                .claimNumber("C1")
                .certificateNumber("CERT1")
                .groupNumber(null)     // required
                .corrTransactionId(null) // required
                .build();

        DataFormatException ex = assertThrows(
                DataFormatException.class,
                () -> invokeBuildDestinationUri("file.txt", metadata)
        );

        assertTrue(ex.getMessage().contains("Missing required field"));
    }

    // ----------------------------------------------------------
    // PRIVATE REFLECTION HELPERS TO TEST PRIVATE METHODS
    // ----------------------------------------------------------
    private String invokeBuildSourceUri(String file) throws Exception {
        var method = FileTransferEventService.class.getDeclaredMethod("buildSourceUri", String.class);
        method.setAccessible(true);
        return (String) method.invoke(service, file);
    }

    private String invokeBuildDestinationUri(String f, MetadataModel m) throws Exception {
        var method = FileTransferEventService.class.getDeclaredMethod("buildDestinationUri",
                String.class, MetadataModel.class);
        method.setAccessible(true);
        return (String) method.invoke(service, f, m);
    }
}






import com.aflac.eib.extream.content.exception.ApplicationException;
import com.aflac.eib.extream.content.model.FileTransferEvent;
import com.aflac.eib.extream.content.model.FileTransferRequest;
import com.aflac.eib.extream.content.model.MetadataModel;
import com.aflac.eib.extream.content.producer.ExtreamContentFileTransferProducer;
import com.aflac.eib.extream.content.properties.S3Properties;
import com.aflac.eib.extream.content.service.FileTransferEventService;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class FileTransferEventServiceTest {

    private S3Properties s3Properties;
    private ExtreamContentFileTransferProducer producer;
    private FileTransferEventService service;

    @BeforeEach
    void setup() {
        s3Properties = mock(S3Properties.class);
        producer = mock(ExtreamContentFileTransferProducer.class);
        service = new FileTransferEventService(s3Properties, producer);
    }

    @Test
    void publishFileTransferEvent_Success_SendsProducerWithCorrectEvent() throws Exception {

        // Arrange
        when(s3Properties.getBucketName()).thenReturn("my-bucket");
        String key = "folder/file.pdf";

        MetadataModel metadata = MetadataModel.builder()
                .claimNumber("CLM-1")
                .certificateNumber("CERT-2")
                .groupNumber("6001")
                .corrTransactionId("TXN-999")
                .corrSubTransactionId("SUB-1")
                .eventName("UPLOAD")
                .disbursementId("D-5")
                .documentClass("DOC")
                .objectStore("STORE-1")
                .acc("ACC-7")
                .title("My File")
                .build();

        // Act
        service.publishFileTransferEvent(key, metadata);

        // Assert
        ArgumentCaptor<FileTransferEvent> eventCaptor = ArgumentCaptor.forClass(FileTransferEvent.class);
        verify(producer, times(1)).send(eventCaptor.capture());

        FileTransferEvent event = eventCaptor.getValue();
        assertNotNull(event);

        FileTransferRequest req = event.getFileTransferRequest();
        assertNotNull(req);

        // Validate Source URI
        assertEquals("s3://my-bucket/folder/file.pdf", req.getSourceURI());

        // Validate Destination URI
        List<String> dests = req.getDestinationURIs();
        assertNotNull(dests);
        assertEquals(1, dests.size());

        String destination = dests.get(0);
        assertTrue(destination.startsWith("filenet://folder/file.pdf?"),
                "Destination must start with filenet://<fileName>?");

        // Check query params presence
        assertTrue(destination.contains("claimNumber=CLM-1"));
        assertTrue(destination.contains("certificateNumber=CERT-2"));
        assertTrue(destination.contains("groupNumber=6001"));
        assertTrue(destination.contains("corrTransactionId=TXN-999"));
        assertTrue(destination.contains("corrSubTransactionId=SUB-1"));
        assertTrue(destination.contains("eventName=UPLOAD"));
        assertTrue(destination.contains("disbursementId=D-5"));
        assertTrue(destination.contains("documentClass=DOC"));
        assertTrue(destination.contains("objectStore=STORE-1"));
        assertTrue(destination.contains("acc=ACC-7"));
        assertTrue(destination.contains("title=My File"));

        // Response required flag is TRUE
        assertEquals(Boolean.TRUE, req.getIsResponseRequired());
    }

    @Test
    void publishFileTransferEvent_ProducerThrows_WrapsInApplicationException() throws Exception {

        when(s3Properties.getBucketName()).thenReturn("bucket");
        String key = "file.txt";

        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        doThrow(new RuntimeException("Kafka down"))
                .when(producer).send(any(FileTransferEvent.class));

        ApplicationException ex = assertThrows(ApplicationException.class,
                () -> service.publishFileTransferEvent(key, metadata));

        assertTrue(ex.getMessage().toLowerCase().contains("failed to publish file transfer event"));
    }

    @Test
    void publishFileTransferEvent_MissingBucket_ThrowsApplicationException() {

        when(s3Properties.getBucketName()).thenReturn(null);

        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        ApplicationException ex = assertThrows(ApplicationException.class,
                () -> service.publishFileTransferEvent("file.pdf", metadata));

        assertTrue(ex.getMessage().toLowerCase().contains("failed to publish file transfer event"));
    }

    @Test
    void publishFileTransferEvent_NullKey_ThrowsApplicationException() {

        when(s3Properties.getBucketName()).thenReturn("bucket");

        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        ApplicationException ex = assertThrows(ApplicationException.class,
                () -> service.publishFileTransferEvent(null, metadata));

        assertTrue(ex.getMessage().toLowerCase().contains("failed to publish file transfer event"));
    }

    @Test
    void publishFileTransferEvent_MissingRequiredMetadataFields_ThrowsApplicationException() {

        when(s3Properties.getBucketName()).thenReturn("bucket");
        String key = "doc.pdf";

        MetadataModel metadataMissingGroup = MetadataModel.builder()
                .corrTransactionId("TXN-1")
                .build();

        ApplicationException ex1 = assertThrows(ApplicationException.class,
                () -> service.publishFileTransferEvent(key, metadataMissingGroup));

        assertTrue(ex1.getMessage().toLowerCase().contains("failed to publish file transfer event"));

        MetadataModel metadataMissingTxn = MetadataModel.builder()
                .groupNumber("G-2")
                .build();

        ApplicationException ex2 = assertThrows(ApplicationException.class,
                () -> service.publishFileTransferEvent(key, metadataMissingTxn));

        assertTrue(ex2.getMessage().toLowerCase().contains("failed to publish file transfer event"));
    }

    @Test
    void publishFileTransferEvent_NullOptionalFields_AreSafelyBlankInDestinationUri() throws Exception {

        when(s3Properties.getBucketName()).thenReturn("bucket");
        String key = "a/b/c.txt";

        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G9")
                .corrTransactionId("TX9")
                .claimNumber(null)
                .certificateNumber(null)
                .corrSubTransactionId(null)
                .eventName(null)
                .disbursementId(null)
                .documentClass(null)
                .objectStore(null)
                .acc(null)
                .title(null)
                .build();

        service.publishFileTransferEvent(key, metadata);

        ArgumentCaptor<FileTransferEvent> captor = ArgumentCaptor.forClass(FileTransferEvent.class);
        verify(producer).send(captor.capture());

        String dest = captor.getValue().getFileTransferRequest().getDestinationURIs().get(0);

        // Optional fields should appear as empty strings
        assertTrue(dest.contains("claimNumber="));
        assertTrue(dest.contains("certificateNumber="));
        assertTrue(dest.contains("corrSubTransactionId="));
        assertTrue(dest.contains("eventName="));
        assertTrue(dest.contains("disbursementId="));
        assertTrue(dest.contains("documentClass="));
        assertTrue(dest.contains("objectStore="));
        assertTrue(dest.contains("acc="));
        assertTrue(dest.contains("title="));
    }
}












Write unit testcases for this: @Service 25 usages

@RequiredArgsConstructor

public class EExstreamContentService {

private final S3Service s3Service;

private final-FileTransferEventService fileTransferEventService;

private final MetadataParserUtil metadataParserUtil;

private final FileConversionUtil fileConversionUtil;

public void processDocument(DocumentRequest documentRequest) throws ApplicationException{ 1 usage

try{

byte[] pdfBytes = fileConversionUtil.convertBase64ToPdf(

documentRequest.getDataFileContent(), ); documentRequest.getDataFileName()

MetadataModel metadata métadataParserUtil.parseTxtToMetadata( documentRequest.getMetadataFileContent(), documentRequest.getMetadataFileName() );PutObjectResponse putObjectResponse2 = s3Service.uploadFile(documentRequest.getMetadataFileName(),if (putObjectResponse1 == null || putObjectResponse1.sdkHttpResponse() == null

||putObjectResponse1.sdkHttpResponse().isSuccessful() || putobjectResponse2 == null || putObjectResponse2.sdkHttpResponse() == null|| !putObjectResponse2.sdkHttpResponse().isSuccessful()) {

AppLogger.error(this.getClass(), msg: "File upload to S3 failed");

throw new ApplicationException("File upload to S3 failed", null, ExceptionType.TECHNICAL);

fileTransferEventService.publishFileTransferEvent(documentRequest.getDataFileName(), metadata);

AppLogger.info(this.getClass(), msg: "Files uploaded to S3 bucket and file transfer event published");

} catch (ApplicationException e) {

AppLogger.error(this.getClass(), msg: "File upload process failed. Reason: {}", e.getMessage(), e);

throw new ApplicationException("File upload process failed", e, ExceptionType.TECHNICAL);}}} documentRequest.getMetadataFileContent().getBytes(StandardCharsets.UTF_8));














import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

import java.nio.charset.StandardCharsets;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class EExstreamContentServiceTest {

    private S3Service s3Service;
    private FileTransferEventService fileTransferEventService;
    private MetadataParserUtil metadataParserUtil;
    private FileConversionUtil fileConversionUtil;

    private EExstreamContentService service;

    @BeforeEach
    void setup() {
        s3Service = mock(S3Service.class);
        fileTransferEventService = mock(FileTransferEventService.class);
        metadataParserUtil = mock(MetadataParserUtil.class);
        fileConversionUtil = mock(FileConversionUtil.class);

        service = new EExstreamContentService(
                s3Service,
                fileTransferEventService,
                metadataParserUtil,
                fileConversionUtil
        );
    }

    private DocumentRequest sampleRequest() {
        DocumentRequest req = new DocumentRequest();
        req.setDataFileName("doc.pdf");
        req.setMetadataFileName("meta.txt");
        req.setDataFileContent("BASE64_DATA");
        req.setMetadataFileContent("key=value");
        return req;
    }

    // SUCCESS FLOW
    @Test
    void processDocument_Success() throws Exception {

        DocumentRequest request = sampleRequest();

        byte[] pdfBytes = "PDF_BYTES".getBytes(StandardCharsets.UTF_8);
        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("TXN")
                .build();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenReturn(pdfBytes);

        when(metadataParserUtil.parseTxtToMetadata(anyString(), anyString()))
                .thenReturn(metadata);

        PutObjectResponse okResponse = mock(PutObjectResponse.class);
        when(okResponse.sdkHttpResponse()).thenReturn(mock(SdkHttpResponse.class));
        when(okResponse.sdkHttpResponse().isSuccessful()).thenReturn(true);

        when(s3Service.uploadFile(eq("doc.pdf"), eq(pdfBytes))).thenReturn(okResponse);
        when(s3Service.uploadFile(eq("meta.txt"), any())).thenReturn(okResponse);

        // Act
        service.processDocument(request);

        // Assert → Event triggered
        verify(fileTransferEventService, times(1))
                .publishFileTransferEvent("doc.pdf", metadata);
    }

    // Base64 → PDF conversion failure
    @Test
    void processDocument_ConvertPdfFails_ThrowsApplicationException() throws Exception {

        DocumentRequest request = sampleRequest();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenThrow(new ApplicationException("convert failed", null, ExceptionType.TECHNICAL));

        assertThrows(ApplicationException.class,
                () -> service.processDocument(request));
    }

    // Metadata TXT parsing failure
    @Test
    void processDocument_ParseMetadataFails_ThrowsApplicationException() throws Exception {

        DocumentRequest request = sampleRequest();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenReturn("PDF".getBytes());

        when(metadataParserUtil.parseTxtToMetadata(anyString(), anyString()))
                .thenThrow(new ApplicationException("parse failed", null, ExceptionType.TECHNICAL));

        assertThrows(ApplicationException.class,
                () -> service.processDocument(request));
    }

    // S3 upload failure
    @Test
    void processDocument_S3UploadFails_ThrowsApplicationException() throws Exception {

        DocumentRequest request = sampleRequest();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenReturn("PDF".getBytes());

        when(metadataParserUtil.parseTxtToMetadata(anyString(), anyString()))
                .thenReturn(MetadataModel.builder().groupNumber("G1").corrTransactionId("T1").build());

        PutObjectResponse badResponse = mock(PutObjectResponse.class);
        when(badResponse.sdkHttpResponse()).thenReturn(mock(SdkHttpResponse.class));
        when(badResponse.sdkHttpResponse().isSuccessful()).thenReturn(false);

        when(s3Service.uploadFile(anyString(), any())).thenReturn(badResponse);

        assertThrows(ApplicationException.class,
                () -> service.processDocument(request));
    }

    // FileTransferEventService throws – should wrap exception
    @Test
    void processDocument_EventPublishFails_ThrowsApplicationException() throws Exception {

        DocumentRequest request = sampleRequest();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenReturn("PDF".getBytes());

        MetadataModel metadata = MetadataModel.builder()
                .groupNumber("G1").corrTransactionId("TX").build();

        when(metadataParserUtil.parseTxtToMetadata(anyString(), anyString()))
                .thenReturn(metadata);

        PutObjectResponse okResp = mock(PutObjectResponse.class);
        when(okResp.sdkHttpResponse()).thenReturn(mock(SdkHttpResponse.class));
        when(okResp.sdkHttpResponse().isSuccessful()).thenReturn(true);

        when(s3Service.uploadFile(anyString(), any())).thenReturn(okResp);

        doThrow(new ApplicationException("kafka fail", null, ExceptionType.TECHNICAL))
                .when(fileTransferEventService)
                .publishFileTransferEvent(anyString(), any());

        assertThrows(ApplicationException.class,
                () -> service.processDocument(request));
    }
}















class EExstreamContentServiceTest {

    private S3Service s3Service;
    private FileTransferEventService fileTransferEventService;
    private MetadataParserUtil metadataParserUtil;
    private FileConversionUtil fileConversionUtil;

    private EExstreamContentService service;

    @BeforeEach
    void setup() {
        s3Service = mock(S3Service.class);
        fileTransferEventService = mock(FileTransferEventService.class);
        metadataParserUtil = mock(MetadataParserUtil.class);
        fileConversionUtil = mock(FileConversionUtil.class);

        service = new EExstreamContentService(
                s3Service,
                fileTransferEventService,
                metadataParserUtil,
                fileConversionUtil
        );
    }

    private PutObjectResponse ok() {
        SdkHttpResponse http = mock(SdkHttpResponse.class);
        when(http.isSuccessful()).thenReturn(true);

        PutObjectResponse resp = mock(PutObjectResponse.class);
        when(resp.sdkHttpResponse()).thenReturn(http);

        return resp;
    }

    private PutObjectResponse notok() {
        SdkHttpResponse http = mock(SdkHttpResponse.class);
        when(http.isSuccessful()).thenReturn(false);

        PutObjectResponse resp = mock(PutObjectResponse.class);
        when(resp.sdkHttpResponse()).thenReturn(http);

        return resp;
    }

    private DocumentRequest req() {
        DocumentRequest r = new DocumentRequest();
        r.setDataFileName("file.pdf");
        r.setDataFileContent("BASE64");
        r.setMetadataFileName("file.txt");
        r.setMetadataFileContent("groupNumber:G1\ncorrTransactionId:T1");
        return r;
    }

    @Test
    void success_happyPath() throws Exception {
        DocumentRequest r = req();

        byte[] pdf = "PDF".getBytes(StandardCharsets.UTF_8);

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn(pdf);

        MetadataModel md = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenReturn(md);

        when(s3Service.uploadFile(r.getDataFileName(), pdf)).thenReturn(ok());
        when(s3Service.uploadFile(
                r.getMetadataFileName(),
                r.getMetadataFileContent().getBytes(StandardCharsets.UTF_8)
        )).thenReturn(ok());

        assertDoesNotThrow(() -> service.processDocument(r));

        verify(fileTransferEventService, times(1))
                .publishFileTransferEvent(r.getDataFileName(), md);
    }

    @Test
    void fails_whenPdfConversionFails() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(anyString(), anyString()))
                .thenThrow(new ApplicationException("convert fail", null, null));

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex.getMessage().toLowerCase().contains("file upload process failed"));
        verifyNoInteractions(s3Service, fileTransferEventService);
    }

    @Test
    void fails_whenMetadataParsingFails() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn("PDF".getBytes(StandardCharsets.UTF_8));

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenThrow(new ApplicationException("parse fail", null, null));

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex.getMessage().toLowerCase().contains("file upload process failed"));
        verifyNoInteractions(s3Service, fileTransferEventService);
    }

    @Test
    void fails_whenDataUploadNullResponse() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn("PDF".getBytes(StandardCharsets.UTF_8));

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenReturn(MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build()
        );

        when(s3Service.uploadFile(r.getDataFileName(), "PDF".getBytes(StandardCharsets.UTF_8)))
                .thenReturn(null);

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex.getMessage().toLowerCase().contains("file upload process failed"));

        verify(fileTransferEventService, never())
                .publishFileTransferEvent(anyString(), any());
    }

    @Test
    void fails_whenDataUploadHttpNotSuccessful() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn("PDF".getBytes(StandardCharsets.UTF_8));

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenReturn(MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build()
        );

        when(s3Service.uploadFile(
                r.getDataFileName(),
                "PDF".getBytes(StandardCharsets.UTF_8)
        )).thenReturn(notok());

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex.getMessage().toLowerCase().contains("file upload process failed"));

        verify(fileTransferEventService, never())
                .publishFileTransferEvent(anyString(), any());
    }

    @Test
    void fails_whenMetadataUploadNotSuccessful() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn("PDF".getBytes(StandardCharsets.UTF_8));

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenReturn(MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build()
        );

        // Case 1: metadata upload = null
        when(s3Service.uploadFile(r.getDataFileName(), "PDF".getBytes(StandardCharsets.UTF_8)))
                .thenReturn(ok());

        when(s3Service.uploadFile(
                r.getMetadataFileName(),
                r.getMetadataFileContent().getBytes(StandardCharsets.UTF_8)
        )).thenReturn(null);

        ApplicationException ex1 = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex1.getMessage().toLowerCase().contains("file upload process failed"));

        verify(fileTransferEventService, never())
                .publishFileTransferEvent(anyString(), any());

        // Case 2: metadata upload = HTTP unsuccessful
        reset(s3Service);

        when(s3Service.uploadFile(r.getDataFileName(), "PDF".getBytes(StandardCharsets.UTF_8)))
                .thenReturn(ok());

        when(s3Service.uploadFile(
                r.getMetadataFileName(),
                r.getMetadataFileContent().getBytes(StandardCharsets.UTF_8)
        )).thenReturn(notok());

        ApplicationException ex2 = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex2.getMessage().toLowerCase().contains("file upload process failed"));

        verify(fileTransferEventService, never())
                .publishFileTransferEvent(anyString(), any());
    }

    @Test
    void fails_whenFileTransferEventPublishingFails() throws Exception {
        DocumentRequest r = req();

        when(fileConversionUtil.convertBase64ToPdf(
                r.getDataFileContent(),
                r.getDataFileName()
        )).thenReturn("PDF".getBytes(StandardCharsets.UTF_8));

        MetadataModel md = MetadataModel.builder()
                .groupNumber("G1")
                .corrTransactionId("T1")
                .build();

        when(metadataParserUtil.parseTxtToMetadata(
                r.getMetadataFileContent(),
                r.getMetadataFileName()
        )).thenReturn(md);

        when(s3Service.uploadFile(
                r.getDataFileName(),
                "PDF".getBytes(StandardCharsets.UTF_8)
        )).thenReturn(ok());

        when(s3Service.uploadFile(
                r.getMetadataFileName(),
                r.getMetadataFileContent().getBytes(StandardCharsets.UTF_8)
        )).thenReturn(ok());

        doThrow(new ApplicationException("event fail", null, null))
                .when(fileTransferEventService)
                .publishFileTransferEvent(r.getDataFileName(), md);

        ApplicationException ex = assertThrows(
                ApplicationException.class,
                () -> service.processDocument(r)
        );

        assertTrue(ex.getMessage().toLowerCase().contains("file upload process failed"));
    }
}





private PutObjectResponse createSuccessfulResponse() {  
        return (PutObjectResponse) PutObjectResponse.builder()
                .sdkHttpResponse(SdkHttpResponse.builder()
                        .statusCode(200)
                        .build())
                .build();
    }  

    private PutObjectResponse createFailedResponse() {  
        return (PutObjectResponse) PutObjectResponse.builder()
                .sdkHttpResponse(SdkHttpResponse.builder()
                        .statusCode(500)
                        .build())
                .build();
    }  
